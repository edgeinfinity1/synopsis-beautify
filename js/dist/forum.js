(()=>{var t={n:e=>{var s=e&&e.__esModule?()=>e.default:()=>e;return t.d(s,{a:s}),s},d:(e,s)=>{for(var n in s)t.o(s,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:s[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e),t.d(e,{components:()=>T,extend:()=>C,utils:()=>j});const s=flarum.reg.get("core","forum/app");var n=t.n(s);const o=flarum.reg.get("core","common/extend"),r=flarum.reg.get("core","forum/states/DiscussionListState");var i=t.n(r);const c=flarum.reg.get("core","forum/components/DiscussionListItem");var u=t.n(c);function l(t){return l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l(t)}function a(t,e,s){return(e=function(t){var e=function(t){if("object"!=l(t)||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var s=e.call(t,"string");if("object"!=l(s))return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==l(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const p=flarum.reg.get("core","common/Component");var f=t.n(p);const h=flarum.reg.get("core","common/utils/string");function d(t,e){const s=(new DOMParser).parseFromString(t,"text/html"),n=t=>{0!==e?t.nodeType!==Node.TEXT_NODE?Array.from(t.childNodes).forEach(n):t.textContent.length<e?e-=t.textContent.length:(t.textContent=t.textContent.substring(0,e)+"...",e=0):t.parentNode.removeChild(t)};return n(s.body),s.body.innerHTML}class g extends(f()){constructor(){super(...arguments),a(this,"post",void 0),a(this,"length",void 0),a(this,"richExcerpt",void 0)}oninit(t){super.oninit(t),this.post=this.attrs.post,this.length=this.attrs.length,this.richExcerpt=this.attrs.richExcerpt}view(){return m("div",{className:"Synopsis-excerpt"},this.getContent())}getContent(){var t,e;return this.richExcerpt?m.trust(d(null!=(e=this.contentRich())?e:"",this.length)):(0,h.truncate)(null!=(t=this.contentPlain())?t:"",this.length)}contentRich(){return this.post.contentHtml()}contentPlain(){return this.post.contentPlain()}}flarum.reg.add("fof-synopsis","forum/components/Excerpt",g);const y=flarum.reg.get("core","common/components/FieldSet");var x=t.n(y);const b=flarum.reg.get("core","common/utils/ItemList");var v=t.n(b);const S=flarum.reg.get("core","common/components/Switch");var w=t.n(S);const E=flarum.reg.get("core","common/utils/Stream");var P=t.n(E);const O=flarum.reg.get("core","common/extenders");var M=t.n(O);const L=flarum.reg.get("flarum-tags","common/models/Tag");var _=t.n(L);const C=[new(M().Model)(_()).attribute("richExcerpts").attribute("excerptLength")],T={Excerpt:g};flarum.reg.add("fof-synopsis","forum/components",null);const j={truncateHtml:d};flarum.reg.add("fof-synopsis","forum/utils",null),n().initializers.add("fof-synopsis",()=>{(0,o.extend)(i().prototype,"requestParams",function(t){"string"==typeof t.include?t.include=[t.include]:t.include=t.include||[],"first"===n().forum.attribute("synopsis.excerpt_type")?t.include.push("firstPost"):t.include.push("lastPost")}),(0,o.extend)(u().prototype,"infoItems",function(t){var e,s,o,r,i,c;const u=this.attrs.discussion;if(n().session.user&&(null==(e=n().session.user.preferences())||!e.showSynopsisExcerpts))return;const l=u.tags();let a;l&&(a=l[l.length-1]);const p="first"===n().forum.attribute("synopsis.excerpt_type")?u.firstPost():u.lastPost(),f="number"==typeof(null==(s=a)?void 0:s.excerptLength())?null==(o=a)?void 0:o.excerptLength():n().forum.attribute("synopsis.excerpt_length"),h="number"==typeof(null==(r=a)?void 0:r.richExcerpts())?null==(i=a)?void 0:i.richExcerpts():n().forum.attribute("synopsis.rich_excerpts"),d=!!n().session.user&&(null==(c=n().session.user.preferences())?void 0:c.showSynopsisExcerptsOnMobile);if(0!==f&&p){const e=m(g,{post:p,length:f,richExcerpt:h});t.add("excerpt",e,-100),d&&t.add("excerptM",e,-100)}}),(0,o.extend)("flarum/forum/components/SettingsPage","oninit",function(){var t,e;this.showSynopsisExcerpts=P()(null==(t=this.user)||null==(t=t.preferences())?void 0:t.showSynopsisExcerpts),this.showSynopsisExcerptsOnMobile=P()(null==(e=this.user)||null==(e=e.preferences())?void 0:e.showSynopsisExcerptsOnMobile)}),(0,o.extend)("flarum/forum/components/SettingsPage","settingsItems",function(t){t.add("synopsis",x().component({label:n().translator.trans("fof-synopsis.forum.user.settings.summaries-heading"),className:"Settings-Synopsis"},this.summariesItems().toArray()))}),(0,o.extend)("flarum/forum/components/SettingsPage","summariesItems",function(){const t=new(v());if(!this.user)return t;const e=this.user.preferences();return t.add("synopsis-excerpts",w().component({state:null==e?void 0:e.showSynopsisExcerpts,onchange:t=>{var e;this.showSynopsisExcerptsLoading=!0,null==(e=this.user)||e.savePreferences({showSynopsisExcerpts:t}).then(()=>{this.showSynopsisExcerptsLoading=!1,m.redraw()})},loading:this.showSynopsisExcerptsLoading},n().translator.trans("fof-synopsis.forum.user.settings.show-summaries"))),null!=e&&e.showSynopsisExcerpts&&t.add("synopsis-excerpts-mobile",w().component({state:null==e?void 0:e.showSynopsisExcerptsOnMobile,disabled:!(null!=e&&e.showSynopsisExcerpts),onchange:t=>{var e;this.showSynopsisExcerptsOnMobileLoading=!0,null==(e=this.user)||e.savePreferences({showSynopsisExcerptsOnMobile:t}).then(()=>{this.showSynopsisExcerptsOnMobileLoading=!1,window.location.reload()})},loading:this.showSynopsisExcerptsOnMobileLoading},n().translator.trans("fof-synopsis.forum.user.settings.show-summaries-mobile"))),t})})})(),module.exports=e})();
//# sourceMappingURL=forum.js.map